# Обучение с учителем: качество модели
**Постановка задачи.** 
Интернет-магазин «В один клик» продаёт разные товары: для детей, для дома, мелкую бытовую технику, косметику и даже продукты. Отчёт магазина за прошлый период показал, что активность покупателей начала снижаться. Привлекать новых клиентов уже не так эффективно: о магазине и так знает большая часть целевой аудитории. Возможный выход — удерживать активность постоянных клиентов. Сделать это можно с помощью персонализированных предложений.

1. Нужно построить модель, которая предскажет вероятность снижения покупательской активности клиента в следующие три месяца.
2. В исследование нужно включить дополнительные данные финансового департамента о прибыльности клиента: какой доход каждый покупатель приносил компании за последние три месяца.
3. Используя данные модели и данные о прибыльности клиентов, нужно выделить сегменты покупателей и разработать для них персонализированные предложения.

**Заказчик** этого проекта:

«В один клик» — современная компания, поэтому её руководство не хочет принимать решения просто так — только на основе анализа данных и бизнес-моделирования.

**Исходные данные**, предоставляемые для реализации проекта, содержат данные о поведении и времени покупателя на сайте, а также данные о выручке и его продуктовом поведении.

Со стороны заказчика были предоставлены 4 датасета с исходной информацией о покупателях и их активности.

- Файл `market_file.csv` содержит данные о поведении покупателя на сайте, о коммуникациях с покупателем и его продуктовом поведении;
- Файл `market_money.csv` с данными о выручке, которую получает магазин с покупателя, то есть сколько покупатель всего потратил за период взаимодействия с сайтом;
- Файл `market_time.csv` с данными о времени (в минутах), которое покупатель провёл на сайте в течение периода;
- Файл `money.csv` с данными о среднемесячной прибыли покупателя за последние 3 месяца: какую прибыль получает магазин от продаж каждому покупателю.
<br></br>

## Итоговые выводы

На **первом** шаге выполнены следующие задачи:
- произведен импорт данных из исходных файлов, датасеты сохранены в соответствующие датафреймы; 
- для каждого датафрейма `df_market_file`, `df_market_money`, `df_market_time`, `df_money` выведены основные характеристики.
- первичный анализ данных по всем датасетам не выявил наличия пропусков и явных полных дубликатов, а также необходимости производить переводы данных в другие типы. 
<br></br>

На **втором** шаге выполнены следующие задачи: 
- для всех датафремов:
    - не обнаружено пропусков значений в столбцах и полных явных дубликатов;
    - определено, что значения в столбцах соответствуют их типу;
    - произведено переименование столбцов;
- для датафрейма `df_market_file` также:
    - устранены неявные дубликаты в столбцах с категориальными значениями, значения приведены к единому формату.
- для датафреймов `df_market_money` и `df_market_time` также:
    - обнаружены явные дубликаты в столбце `id`, что соответствует наличию данных за несколько месяцев;
    - неявных дубликатов в столбцах с категориальными значениями не обнаружено, значения приведены к единому формату.
<br></br>       
    
На **третьем** шаге выполнены следующие задачи: 
- для всех датафреймов:
    - определены количественные признаки;
    - выведены статистические характеристики и построены графики распределения для всех количественных признаков;
    - определены категориальные признаки;
    - выведены графики распределения количества записей в датасете для всех категориальных признаков.
    
- в датафрейме `df_market_file`:
    - большая часть показателей относится к дискретным величинам;
    - большая часть значений распределены близко к нормальному с незначительными либо отсутствующими выбросами;
    - по столбцу `promo_purchases_ratio` распределение близко к бимодальному;
    - выявлен небольшой дисбаланс классов по целевому показателю;
    - самая популярная категория товаров среди покупателей `товары для детей`, доля записей составляет `25.38%`. Меньше всего покупатели отдают предпочтение категории `кухонная посуда`, доля составляет `10.62%`.
      
- в датафрейме `df_market_money`:
    - удалена строка с выбивающимся значением, после удаления распределение значений близко к нормальному с незначительными выбросами;
    - данные распределены в равных пропорциях по трем месяцам;
        
- в датафрейме `df_market_time`:
    - данные распределены близко к нормальному, выбивающихся значений нет.
    - данные распределены в равных пропорциях по двум месяцам;
        
- в датафрейме `df_money`:
    - данные распределены близко к нормальному, есть незначительная доля выбивающихся значений.
    - категориальные признаки в датасете отсутствуют.
<br></br>    
    
На **четвертом** шаге:
- проведено объединение исходных датасетов в общий датафрейм: после объединения датасетов получили общий датафрейм, состоящий из `17` столбцов и содержащий `1296` строк;
- убраны из рассмотрения пользователи, которые не совершали покупок хотя бы в одном из трех месяцев.
<br></br>

На **пятом** шаге произведен корреляционный анализ количественных показателей:
* целевой признак имеет следующие взаимосвязи с входными признаками:
    - `высокая` взаимосвязь с признаком `Кол-во страниц за визит`;
    - `заметная` взаимосвязь с признаками `Время за текущий месяц, мин.`, `Время за предыдущий месяц, мин.`, `Неоплаченные продукты, шт./квартал`, `Среднее кол-во просмотров категорий за визит`, `Доля акционных покупок`, `Маркет. актив-ть за 6 месяцев`;
    - с остальными признаками целевой взаимосвязан умеренно или слабо, кроме признаков `Маркет. актив-ть в текущем месяце` и `Разрешить сообщать` -- с ними взаимосвязь отсутствует;
    -  утечки данных не наблюдается.
* входные признаки имеют следующие взаимосвязи между собой:
    - `высокая`:
        - `Выручка за текущий месяц`, `Выручка за предыдущий месяц` и `Выручка за предпредыдущий месяц`;
        - `Выручка за предпредыдущий месяц` и `Доля акционных покупок`;
    - `заметная`:
        - `Выручка за предыдущий месяц` и `Доля акционных покупок`;
    - остальные признаки взаимосвязанны умеренно или слабо.
* корреляционная матрица показала, что между некоторыми входными признаками есть корреляция, но нет явных признаков наличия мультиколлинеарности, поскольку коэффициенты корреляции не превышают значения `0.9`.
<br></br>

На **шестом** шаге выполнены следующие задачи: 
- сформированы обучающая и тестовая выборки, при формировании была использована стратификация, чтобы минимизировать влияние дисбаланса классов;
- сформированы пайплайны для предобработки данных:
    - отобраны признаки для кодирования разными кодировщиками, для признака `Тип сервиса` использован кодировщик с ранжированием, для остальных `OneHotEncoder`;
    - для обоих вариантов кодировщиков созданы отдельные пайплайны;
    - сформирован общий пайплайн для подготовки данных;
    - сформирован итоговый пайплайн для работы с моделью;
- реализовано обучение 4-х моделей и выбор лучшей:
    - сформирован список словарей для подбора гиперпараметров;
    - выбрана метрика `ROC-AUC` для оценки моделей;
    - с помощью метода `RandomizedSearchCV` подобрана лучшая модель:
        - модель `KNN` с параметром `k=24`;
        - метрика на тренировочной выборке составила `0.909`
        - метрика на тестовой выборке составила `0.920`
<br></br>

На **седьмом** шаге выполнены следующие задачи:
- с помощью методов библиотеки `shap` осуществлен анализ важности признаков;
- выделены наиболее значимые признаки:
    - `Кол-во страниц за визит`;
    - `Время за предыдущий месяц, мин.`;
    - `Среднее кол-во просмотров категорий за визит`;
    - `Время за текущий месяц, мин.`.
- также определены наименее важные признаки:
    - `Популярная категория`;
    - `Тип сервиса`;
    - `Разрешить сообщать`.
- с помощью диаграммы вклада каждого признака по всем наблюдениям выделены факторы формирования снижения покупательской активности:
    - малое количество просмотренных страниц за визит;
    - малое время проведенное на сайте;
    - малое количество просмотренных категорий на сайте;
    - большая доля акционных товаров;
    - большое количество неоплаченных продуктов в корзине;
<br></br>
     
На **восьмом** шаге выполнены следующие задачи:
- в качестве сегмента для анализа была выбрана группа клиентов с высокой вероятностью снижения покупательской активности с выделением категорий по типам сервиса;
- проанализированы показатели продуктового поведения покупателей и поведения на сайте:
    - у обеих категорий распределение показателей мало чем отличается, за исключением популярных категорий -- покупатели с типом сервиса `стандарт` чаще приобретают товары для детей и дома, тогда как покупатели категории `премиум` чаще приобретают товары личного пользования;
- проанализированы некоторые показатели финансового поведения:
    - для обеих категорий не выявлено существенных различий в распределении полученной прибыли и товаров, приобретаемых по акции.
<br></br>

**Рекомендации**

Возможным вариантом способа увеличения покупательской активности будет предоставление возможности покупателям выбирать раз в месяц любимые категории товаров, которые позволят либо приобрести выделенную группу товаров по акции, либо будут предусматривать какие-то бонусы по программе лояльности (например, баллы). 

Также величина этих скидок/бонусов может быть напрямую связана с типом сервиса покупателей (например, для категории `премиум` эти значения будут выше), что может стимулировать покупателей переходить на более высокий уровень сервиса и в дальнейшем при выборе места покупок отдавать предпочтение этому магазину.

Возможно стоит предусмотреть расширение ассортимента в выявленных популярных категориях товаров. 
